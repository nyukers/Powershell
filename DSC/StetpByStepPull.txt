#############################################
# SECTION 1
# 1) Install xPSDesiredStateConfiguration
# 2) Create the Pull Server. 

# SECTION 2
# Create my Host Configuration

# SECTION 3
# Execute my code on the Target Host

#############################################
# SECTION 1
# Execute this section on DSC Server !!!
#############################################

# Step 1 Install xPSDesiredStateConfiguration
Install-Module -Name xPSDesiredStateConfiguration

# Step 2
# Create the Pull Server. 

Configuration CreatePullServer {
  param (
    [string[]]$ComputerName = 'localhost'
  )

  Import-DSCResource -ModuleName xPSDesiredStateConfiguration
  Import-DSCResource –ModuleName PSDesiredStateConfiguration

  Node $ComputerName {
    WindowsFeature DSCServiceFeature {
      Ensure = "Present"
      Name  = "DSC-Service"
    }

    xDscWebService PSDSCPullServer {
      Ensure         = "Present"
      UseSecurityBestPractices = 0
      EndpointName      = "PSDSCPullServer"
      Port          = 8080
      PhysicalPath      = "$env:SystemDrive\inetpub\wwwroot\PSDSCPullServer"
      CertificateThumbPrint  = "AllowUnencryptedTraffic"
      ModulePath       = "$env:PROGRAMFILES\WindowsPowerShell\DscService\Modules"
      ConfigurationPath    = "$env:PROGRAMFILES\WindowsPowerShell\DscService\Configuration"
      State          = "Started"
      DependsOn        = "[WindowsFeature]DSCServiceFeature"
    }

  }

}

#Creates the .mof file
CreatePullServer


# Apply the Pull Server configuration to the Pull Server
Start-DscConfiguration .\CreatePullServer -Wait

#############################################
# SECTION 2
# Execute this section on DSC Server !!!
#############################################

# Your Configuration
Configuration ExchangeService {

    # Parameters
    # Accepts a string value computername or defaults to localhost
    Param([string[]]$ComputerName = "localhost")

    # Target Node
    Node $ComputerName {

        # Service Resource
        # Ensure a service is started
        Service MSExchangeTransport {
            Name = 'MSExchangeTransport'
            State = 'Running'
        }
    }
}

# Generate the .MOF files
 ExchangeService -Computername EXCH
 
# Create a Checksum for the file listed above
 New-DscChecksum ".\exchangeservice\exch.mof"

# Files
# .\exchangeservice\exch.mof
# .\exchangeservice\exch.mof.cheksum
# copy to
# C:\Program files\WindowsPowershell\DscService\Configuration

#############################################
# SECTION 3
# Execute this section on the Target Host !!!
#############################################

# Run on the target node
Configuration LCMPullConfig 
{ 
    LocalConfigurationManager 
    { 
        ConfigurationID = "EXCH"; # it's must be EQUAL to filename EXCH.mof
        RefreshMode = "PULL";
        DownloadManagerName = "WebDownloadManager";
        RebootNodeIfNeeded = $true;
        RefreshFrequencyMins = 30;
        ConfigurationModeFrequencyMins = 30; 
        ConfigurationMode = "ApplyAndAutoCorrect";
        DownloadManagerCustomData = @{
        ServerUrl = "http://ServerName:8080/PSDSCPullServer/PSDSCPullServer.svc"; 
        AllowUnsecureConnection = "TRUE"}
    } 
} 

# Create the .mof meta file for the target node
LCMPullConfig

# We're essentially turning on Pull Mode on the Target
Set-DSCLocalConfigurationManager -Computer localhost -Path ./LCMPullConfig -Verbose

